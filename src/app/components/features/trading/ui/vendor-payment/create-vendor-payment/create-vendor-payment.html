@if(loading) {
  <app-skelton-loader 
  variant="text"
  [lines]="10"
  width="100%"
  [shimmer]="true" />
} @else if(!loading && mode() === 'edit' && vendorPaymentStore.error()) {
  <app-item-not-found
  title="Vendor payment record not found"
  description="It may have been deleted or the link is invalid."></app-item-not-found>
} @else if(!loading && (mode() === 'create' || mode() === 'edit') && !vendorPaymentStore.error()) {
<!-- ðŸ”· Form Title -->
<h1 class="text-2xl font-semibold text-gray-800 mb-6 text-center">
  {{ title() }}
</h1>
<form [formGroup]="form" (ngSubmit)="handleSubmit()"
  class="grid grid-cols-1 gap-6 max-w-6xl mx-auto p-6 bg-white shadow rounded">

  <div class="p-4 border border-gray-300 rounded bg-white">
    <h2 class="font-semibold text-base mb-4">Basic Details</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-25 gap-y-4">

      <!-- Date -->
      <div class="flex flex-col gap-1">
        @let pmtdate = form.get('pmtdate');
        @let pmtdateInvalid = pmtdate?.invalid && (pmtdate?.dirty || pmtdate?.touched);
        <div class="flex items-center gap-2">
          <label class="w-32 text-sm text-gray-700">
            Payment Date <span class="text-danger">*</span>
          </label>

          <input formControlName="pmtdate" type="date" [ngClass]="{
              'flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 focus:outline-none': true,
              'focus:border-b-primary border-b-gray-300': !pmtdateInvalid,
              'border-b-danger': pmtdateInvalid
            }" />
        </div>

        @if (pmtdate?.hasError('required') && (pmtdate?.dirty || pmtdate?.touched)) {
        <p class="text-danger text-xs mt-1">Payment date is required.</p>
        }
      </div>

      <!-- Vendor -->
      <div class="flex flex-col gap-1">
        @let vendor = form.get('vendor');

        <div class="flex items-center gap-2">
          <label class="w-32 text-sm text-gray-700">
            Vendor <span class="text-danger">*</span>
          </label>

          <app-auto-complete
            formControlName="vendor"
            [options]="filteredVendors()"
            class="flex-1"
            placeholder="Search for a vendor"
            [required]="true"
            inputClass="flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 placeholder-gray-400 focus:outline-none focus:border-b-primary border-b-gray-300"
            [optionDisplayValue]="findVendorDisplayValue"
            [inputDisplayValue]="findVendorInputDisplayValue"
            (onOptionSelected)="onVendorSelected($event)"
            (onSearch)="onVendorSearch($event)">
          </app-auto-complete>
        </div>

        @if (vendor?.hasError('required') && (vendor?.dirty || vendor?.touched)) {
        <p class="text-danger text-xs mt-1">Vendor is required.</p>
        }
      </div>

      <!-- Amount -->
      <div class="flex flex-col gap-1">
        @let amount = form.get('amount');
        @let amountInvalid = amount?.invalid && (amount?.dirty || amount?.touched);

        <div class="flex items-center gap-2">
          <label class="w-32 text-sm text-gray-700">
            Amount <span class="text-danger">*</span>
          </label>

          <input formControlName="amount" type="number" inputmode="decimal" step="0.01" [ngClass]="{
              'flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 focus:outline-none': true,
              'focus:border-b-primary border-b-gray-300': !amountInvalid,
              'border-b-danger': amountInvalid
            }" />
        </div>

        @if (amount?.hasError('required') && (amount?.dirty || amount?.touched)) {
        <p class="text-danger text-xs mt-1">Amount is required.</p>
        }
        @if (amount?.hasError('min') && (amount?.dirty || amount?.touched)) {
        <p class="text-danger text-xs mt-1">Amount must be greater than 0.</p>
        }
      </div>

      <!-- Currency -->
      <div class="flex flex-col gap-1">
        @let currency = form.get('currency');

        <div class="flex items-center gap-2">
          <label class="w-32 text-sm text-gray-700">
            Currency <span class="text-danger">*</span>
          </label>

          <app-auto-complete
            formControlName="currency"
            [options]="filteredCurrencies()"
            class="flex-1"
            placeholder="Search for a currency"
            [required]="true"
            inputClass="flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 placeholder-gray-400 focus:outline-none focus:border-b-primary border-b-gray-300"
            [optionDisplayValue]="findCurrencyDisplayValue"
            [inputDisplayValue]="findCurrencyInputDisplayValue"
            (onSearch)="onCurrencySearch($event)">
          </app-auto-complete>
        </div>

        @if (currency?.hasError('required') && (currency?.dirty || currency?.touched)) {
        <p class="text-danger text-xs mt-1">Currency is required.</p>
        }
      </div>

      <!-- Bank/Cash -->
      <div class="flex flex-col gap-1">
        @let bcash = form.get('bcash');

        <div class="flex items-center gap-2">
          <label class="w-32 text-sm text-gray-700">
            Bank/Cash <span class="text-danger">*</span>
          </label>

          <app-auto-complete
            formControlName="bcash"
            [options]="filteredBankCashes()"
            class="flex-1"
            placeholder="Search for a bank/cash account"
            [required]="true"
            inputClass="flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 placeholder-gray-400 focus:outline-none focus:border-b-primary border-b-gray-300"
            [optionDisplayValue]="findBankCashDisplayValue"
            [inputDisplayValue]="findBankCashInputDisplayValue"
            (onSearch)="onBankCashSearch($event)">
          </app-auto-complete>
        </div>

        @if (bcash?.hasError('required') && (bcash?.dirty || bcash?.touched)) {
        <p class="text-danger text-xs mt-1">Bank/Cash account is required.</p>
        }
      </div>

      <!-- Description -->
      <div class="flex flex-col gap-1 md:col-span-2">
        <div class="flex items-start gap-2">
          <label class="w-32 text-sm text-gray-700 pt-1">Description</label>
          <textarea formControlName="description" rows="2"
            class="flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 focus:outline-none focus:border-b-primary border-b-gray-300"></textarea>
        </div>
      </div>

    </div>
  </div>

  <div formArrayName="invoices" class="p-4 bg-white mt-6">
    <h2 class="font-semibold text-base mb-4">Related Invoices</h2>
    <table class="border-collapse text-sm">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-200">
          <th class="text-left font-semibold text-gray-700 py-2 px-3 text-center px-3 w-[60%]">Invoice</th>
          <th class="text-left font-semibold text-gray-700 py-2 text-center w-[30%]">Amount</th>
          <th class="text-left font-semibold text-gray-700 py-2 px-3 text-center w-[10%]">Actions</th>
        </tr>
      </thead>
    
      <tbody>
        @for (invoice of invoices.controls; track invoice.value.invoice?.number ?? $index; let i = $index) {
          <tr [formGroup]="invoice"  class="hover:bg-gray-50 transition-colors border-b border-gray-100">
            <td class="py-2.5 px-3 text-gray-800">
              <app-auto-complete
                formControlName="invoice"
                [options]="purchaseInvoices()"
                class="flex-1"
                placeholder="Search for an invoice"
                [required]="true"
                inputClass="flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 placeholder-gray-400 focus:outline-none focus:border-b-primary border-b-gray-300"
                [optionDisplayValue]="findInvoiceDisplayValue"
                [inputDisplayValue]="findInvoiceDisplayValue"
                (onSearch)="onInvoiceSearch($event)">
              </app-auto-complete>
            </td>
            <td class="py-2.5 px-3 text-gray-800">
              <input formControlName="amount" appNumberInput [ngClass]="{
                'flex-1 border-0 border-b bg-transparent text-sm leading-tight pt-0.5 pb-1 px-0 focus:outline-none': true,
                'focus:border-b-primary border-b-gray-300': !amountInvalid,
                'border-b-danger': amountInvalid
              }" />
            </td>
            <td class="py-2.5 px-3 text-center">
              <div class="flex justify-center items-center gap-3">
                <button
                  type="button"
                  class="text-primary hover:text-primary-hover transition cursor-pointer"
                  (click)="onAddInvoice()"
                  matTooltip="Add invoice"
                >
                  <ng-icon name="bootstrapPlusSquare" size="18"></ng-icon>
                </button>
            
                <button
                  type="button"
                  class="text-danger hover:text-danger-hover transition cursor-pointer"
                  (click)="onRemoveInvoice(i)"
                  matTooltip="Remove invoice"
                >
                  <ng-icon name="bootstrapTrash" size="18"></ng-icon>
                </button>
              </div>
            </td>
            
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- âœ… Submit Button -->
  <div class="pt-2 mt-4 text-center">
    <app-cancel-button></app-cancel-button>

    <button type="submit" class="bg-primary text-white px-6 py-2 rounded hover:opacity-90 cursor-pointer"
      [disabled]="submitting()" [ngClass]="{
      'cursor-not-allowed opacity-50': submitting(),
      'cursor-pointer': !submitting()
    }">
      Submit
    </button>
  </div>
</form>
}

